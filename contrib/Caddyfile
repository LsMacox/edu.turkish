# Global options
{
    auto_https disable_redirects  # Разрешаем HTTPS для сайтов с tls, но без авто-редиректов
    email {$CADDY_ACME_EMAIL}     # Email для Let's Encrypt
}

# App (Nuxt) origin — ВАЖНО: это не публичный домен, а origin-хост
http://{$APP_DOMAIN} {
    encode zstd gzip

    @static path_regexp static \.\nw{2,5}$
    header @static Cache-Control "public, max-age=31536000, immutable"

    reverse_proxy app:3000 {
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Host {host}
        header_up Host {host}
    }
}

# Directus origin
http://{$DIRECTUS_DOMAIN} {
    redir https://{$DIRECTUS_DOMAIN}{uri} 308
}
https://{$DIRECTUS_DOMAIN} {
    encode zstd gzip

    # basicauth можно оставить закомментированным
    reverse_proxy directus:8055 {
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Host {host}
        header_up Host {host}
    }

    tls {$CADDY_ACME_EMAIL}
}

# EspoCRM origin
http://{$CRM_DOMAIN} {
    redir https://{$CRM_DOMAIN}{uri} 308
}
https://{$CRM_DOMAIN} {
    encode zstd gzip

    reverse_proxy espocrm:80 {
        header_up X-Forwarded-Proto {scheme}
        header_up X-Forwarded-Host {host}
        header_up Host {host}
    }

    tls {$CADDY_ACME_EMAIL}
}

# НИКАКИХ редиректов с :80 на https здесь быть не должно
# Если нужен healthcheck:
:80 {
    @health path /health
    respond @health "ok" 200
    respond 404
}
