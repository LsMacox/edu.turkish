# Проверка качества i18n переводов

## Назначение

Скрипт `scripts/i18n-check.ts` анализирует файлы переводов i18n для выявления проблем качества:

- **Дубликаты ключей** — один и тот же ключ определён в нескольких файлах одной локали
- **Неиспользуемые ключи** — ключи, которые определены в файлах переводов, но не используются в коде
- **Отсутствующие переводы** — ключи, которые есть в одних локалях, но отсутствуют в других
- **Пустые структуры** — объекты без значений (содержат только пустые вложенные объекты)

Скрипт предназначен для ручного запуска разработчиками. Вывод скрипта структурирован так, чтобы LLM-инструменты могли понять проблемы и автоматически их исправить.

## Предварительные требования

- Node.js 18.17+
- Установленные зависимости: `npm install`
- Файлы переводов в `i18n/locales/{en,ru,kk,tr}/`

## Запуск

### Через npm-скрипт (рекомендуется)

```bash
npm run i18n:check
```

### Напрямую через tsx

```bash
npx tsx scripts/i18n-check.ts
```

## Опции

### `--verbose`

Включает подробный вывод с информацией о прогрессе выполнения.

```bash
npm run i18n:check -- --verbose
```

**Вывод**:

```
Loading locale files...
✓ Loaded en: 156 keys from 16 files
✓ Loaded ru: 158 keys from 16 files
✓ Loaded kk: 152 keys from 16 files
✓ Loaded tr: 148 keys from 16 files

Scanning source files...
✓ Scanned source files, found 298 key usages

Analyzing duplicates...
✓ Found 2 duplicate keys

Analyzing unused keys...
✓ Found 3 unused keys

Analyzing missing keys...
✓ Found 2 missing keys

Generating report...
```

### `--json`

Выводит отчёт в формате JSON вместо текстового формата.

### `--remove-unused`

Удаляет неиспользуемые ключи из файлов переводов после интерактивного подтверждения.

```bash
npm run i18n:check -- --remove-unused
```

**Важно**: Скрипт запросит подтверждение перед удалением. Удаление необратимо, поэтому рекомендуется сделать коммит перед использованием этой опции.

### `--remove-empty`

Удаляет пустые структуры (объекты без значений) из файлов переводов после интерактивного подтверждения.

```bash
npm run i18n:check -- --remove-empty
```

**Пример пустой структуры**:

```json
{
  "faq": {
    "documents": {
      "q1": {},
      "q2": {}
    }
  }
}
```

В этом примере `q1` и `q2` — пустые объекты, которые будут удалены.

```bash
npm run i18n:check -- --json
```

**Использование с jq**:

```bash
npm run i18n:check -- --json | jq '.missingIssues'
```

## Примеры использования

### Базовый запуск

```bash
npm run i18n:check
```

### Подробный вывод

```bash
npm run i18n:check -- --verbose
```

### Сохранение отчёта в файл

```bash
npm run i18n:check > i18n-report.txt
```

### JSON-вывод для обработки

```bash
npm run i18n:check -- --json > report.json
```

### Комбинация флагов

```bash
npm run i18n:check -- --verbose --json
```

## Формат вывода

### Текстовый формат (по умолчанию)

```
=== i18n Translation Keys Quality Report ===
Generated: 2025-10-03 00:16:28
Scanned: 4 locales, 342 total keys, 187 source files

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[DUPLICATE KEYS] (2 issues)

  ❌ Key: "common.submit"
     Locale: ru
     First occurrence: i18n/locales/ru/common.json
     Duplicate in: i18n/locales/ru/components/forms.json

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[UNUSED KEYS] (3 issues)

  ⚠️  Key: "pages.old_feature.title"
     Locale: en
     File: i18n/locales/en/pages/old_feature.json
     (Not found in any source file)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[MISSING KEYS] (2 issues)

  ❌ Key: "pages.new_feature.cta"
     Present in: en, ru, kk
     Missing in: tr

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[EMPTY STRUCTURES] (2 issues)

  ⚠️  Key: "faq.documents.q1"
     Locale: en
     File: i18n/locales/en/pages/faq.json
     (Contains only empty objects with no values)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Summary: 9 total issues (2 duplicates, 3 unused, 2 missing, 2 empty)
```

### JSON формат (`--json`)

```json
{
  "timestamp": "2025-10-03T00:16:28.123Z",
  "scannedLocales": ["en", "ru", "kk", "tr"],
  "totalKeys": 342,
  "totalSourceFiles": 187,
  "duplicateIssues": [
    {
      "type": "duplicate",
      "severity": "error",
      "key": "common.submit",
      "locale": "ru",
      "firstOccurrence": "i18n/locales/ru/common.json",
      "duplicateOccurrence": "i18n/locales/ru/components/forms.json"
    }
  ],
  "unusedIssues": [
    {
      "type": "unused",
      "severity": "warning",
      "key": "pages.old_feature.title",
      "locale": "en",
      "filePath": "i18n/locales/en/pages/old_feature.json"
    }
  ],
  "missingIssues": [
    {
      "type": "missing",
      "severity": "error",
      "key": "pages.new_feature.cta",
      "presentIn": ["en", "ru", "kk"],
      "missingIn": ["tr"]
    }
  ],
  "emptyStructureIssues": [
    {
      "type": "empty",
      "severity": "warning",
      "key": "faq.documents.q1",
      "locale": "en",
      "filePath": "i18n/locales/en/pages/faq.json"
    }
  ],
  "summary": {
    "duplicateCount": 1,
    "unusedCount": 1,
    "missingCount": 1,
    "emptyStructureCount": 1,
    "totalIssues": 4
  }
}
```

## Поведение и ограничения

### Дубликаты ключей

- Скрипт проверяет каждую локаль отдельно
- Дубликат обнаруживается, если один и тот же ключ (в dot-нотации) встречается в разных файлах
- Первое вхождение и дубликат указываются с путями к файлам

### Неиспользуемые ключи

- Скрипт сканирует файлы `.vue`, `.ts`, `.js` в директориях: `app/`, `server/`, `components/`, `pages/`, `composables/`
- Ищет вызовы функций: `t()`, `$t()`, `te()`, `tm()`
- Ключи, которые не найдены ни в одном файле, помечаются как неиспользуемые
- **Ограничение**: динамически сконструированные ключи (например, `t(\`pages.${page}.title\`)`) могут быть частично распознаны или пропущены
- **Ограничение**: ключи в закомментированном коде также считаются использованными (это приемлемо, чтобы не удалить ключи, которые могут быть раскомментированы)

### Отсутствующие переводы

- Скрипт сравнивает все четыре локали: `en`, `ru`, `kk`, `tr`
- Если ключ присутствует хотя бы в одной локали, но отсутствует в других, это фиксируется как проблема
- Отчёт показывает, в каких локалях ключ есть, а в каких отсутствует

### Вложенные ключи

- Скрипт корректно обрабатывает вложенную структуру JSON
- Вложенные объекты преобразуются в dot-нотацию: `{ pages: { home: { title: "x" } } }` → `"pages.home.title"`
- Массивы обрабатываются как конечные узлы (не разворачиваются)

### Коды выхода

- **0** — скрипт выполнен успешно (независимо от того, найдены проблемы или нет)
- **1** — ошибка выполнения (невалидный JSON, отсутствующая директория и т.д.)

**Важно**: Скрипт всегда завершается с кодом 0 при успешном выполнении, даже если найдены проблемы качества. Цель скрипта — отчитаться о проблемах, а не провалить сборку.

## Обработка ошибок

### Невалидный JSON

```
Error: Failed to parse i18n/locales/ru/pages/blog.json: Unexpected token } in JSON at position 234
```

**Решение**: Проверьте синтаксис JSON в указанном файле с помощью `jq`:

```bash
jq '.' i18n/locales/ru/pages/blog.json
```

### Отсутствующая директория локали

```
Error: Locale directory not found: i18n/locales/tr
```

**Решение**: Убедитесь, что все директории локалей существуют:

```bash
mkdir -p i18n/locales/{en,ru,kk,tr}
```

### Запуск не из корня репозитория

```
Error: Locale directory not found: i18n/locales/en
```

**Решение**: Запускайте скрипт из корня репозитория:

```bash
cd /path/to/edu.turkish
npm run i18n:check
```

## Частые проблемы

### Много неиспользуемых ключей

Это может быть нормально, если:

- Ключи используются динамически (с переменными)
- Ключи используются в закомментированном коде
- Ключи планируется использовать в будущем

**Рекомендация**: Проверьте каждый неиспользуемый ключ вручную перед удалением.

### Дубликаты ключей

Обычно это ошибка — один и тот же ключ не должен определяться в разных файлах.

**Решение**:

1. Определите, какое значение правильное
2. Удалите дубликат из одного из файлов
3. Убедитесь, что ключ используется корректно в коде

### Отсутствующие переводы

Это критическая проблема — все локали должны иметь одинаковый набор ключей.

**Решение**:

1. Добавьте отсутствующие ключи в указанные локали
2. Используйте скрипт `translate` для автоматического перевода (см. `docs/scripts/TRANSLATE.md`)

### Пустые структуры

Пустые объекты без значений засоряют файлы переводов и могут указывать на незавершённую работу.

**Решение**:

1. Используйте `--remove-empty` для автоматического удаления
2. Или заполните объекты реальными значениями, если они нужны

```bash
npm run i18n:check -- --remove-empty
```

## Автоматическое исправление

### Удаление неиспользуемых ключей

```bash
npm run i18n:check -- --remove-unused
```

Скрипт:

1. Найдёт все неиспользуемые ключи
2. Покажет список ключей для удаления
3. Запросит подтверждение
4. Удалит ключи из соответствующих файлов
5. Сохранит изменения с правильным форматированием JSON

### Удаление пустых структур

```bash
npm run i18n:check -- --remove-empty
```

Скрипт удалит все объекты, которые:

- Не содержат значений (строк, чисел, массивов)
- Содержат только пустые вложенные объекты

### Комбинированное использование

```bash
npm run i18n:check -- --remove-unused --remove-empty --verbose
```

## Интеграция с LLM

Скрипт разработан для использования с LLM-инструментами:

1. **Запустите скрипт** и сохраните вывод:

   ```bash
   npm run i18n:check > report.txt
   ```

2. **Передайте отчёт LLM** с инструкцией исправить проблемы

3. **LLM может**:
   - Удалить дубликаты
   - Использовать `--remove-unused` для удаления неиспользуемых ключей
   - Использовать `--remove-empty` для удаления пустых структур
   - Добавить отсутствующие переводы

4. **Повторите проверку** после исправлений:
   ```bash
   npm run i18n:check
   ```

## Советы по использованию

- **Регулярно запускайте скрипт** перед коммитом изменений в i18n файлы
- **Используйте `--json`** для автоматической обработки результатов
- **Делайте коммит перед использованием `--remove-unused` или `--remove-empty`** — удаление необратимо
- **Проверяйте неиспользуемые ключи вручную** перед удалением (динамические ключи могут не обнаруживаться)
- **Исправляйте отсутствующие переводы сразу** — они критичны для UX
- **Дубликаты удаляйте немедленно** — они могут привести к несогласованности
- **Пустые структуры удаляйте с помощью `--remove-empty`** — они засоряют файлы

## Производительность

- Скрипт обрабатывает ~64 JSON файла и ~200-500 исходных файлов за <5 секунд
- Для больших проектов время выполнения может увеличиться
- Используйте `--verbose` для отслеживания прогресса

## Связанные скрипты

- `npm run translate` — автоматический перевод контента (см. `docs/scripts/TRANSLATE.md`)
- `npm run import:university` — импорт данных университетов (см. `docs/scripts/IMPORT_UNIVERSITY.md`)

## Поддержка

При возникновении проблем:

1. Убедитесь, что запускаете скрипт из корня репозитория
2. Проверьте, что все директории локалей существуют
3. Проверьте валидность JSON файлов с помощью `jq`
4. Используйте `--verbose` для диагностики
