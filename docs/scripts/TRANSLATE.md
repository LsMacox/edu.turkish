# Скрипт перевода (`scripts/translate.ts`)

Автоматически добавляет недостающие переводы в БД, используя OpenRouter. Скрипт находит записи без нужных локалей и создаёт новые строки в таблицах переводов, не перезаписывая существующие данные.

## Предварительные требования

- Node.js 18+
- Доступ к БД (`DATABASE_URL`)
- Сгенерированный Prisma Client (`npx prisma generate`)
- Ключ OpenRouter: `OPENROUTER_API_KEY`

Пример экспорта переменных окружения:

```bash
export DATABASE_URL="mysql://app_user:***@127.0.0.1:3306/edu_turkish"
export OPENROUTER_API_KEY=sk-or-...
```

## Поддерживаемые сущности

`universities`, `reviews`, `programs`, `faqs`, `facilities`, `requirements`, `documents`, `dates`, `directions`, `scholarships`, `articles`, `all` (последовательно обрабатывает всё перечисленное).

## Запуск

```bash
# через npm-скрипт
npm run translate -- <entity> [опции]

# напрямую
npx tsx scripts/translate.ts <entity> [опции]
```

Где `<entity>` — одно из значений из списка выше.

## Опции

- `--source=<locale>` — исходная локаль (по умолчанию `ru`).
- `--targets=<l1,l2>` — список целевых локалей через запятую (по умолчанию `kk,en,tr`). Исходная локаль автоматически исключается.
- `--limit=<N>` — ограничение количества записей (например, для тестового прогона).
- `--dry-run` — только просмотр. Скрипт выводит предполагаемые переводы, но не пишет в БД и не обращается к OpenRouter.
- `--concurrency=<1..8>` — количество параллельных задач (по умолчанию `2`). Увеличивайте постепенно, чтобы не упереться в лимиты API.

## Поведение

- Переводятся **только отсутствующие локали**. Уникальные индексы Prisma защищают от дубликатов.
- Источник значений: сначала локаль `--source`, затем любая доступная локаль, затем базовые поля сущности.
- JSON-поля (например, `amenities`, `format_requirements`) сериализуются, переводятся как текст и пытаются парситься обратно в JSON.
- Скрипт использует OpenRouter API (`https://openrouter.ai/api/v1/chat/completions`) с моделью `z-ai/glm-4.5`.
- Логи в режиме записи выглядят как `[Created] university_translation u=12 ru->en`; в `--dry-run` добавляется префикс `[DryRun]`.

## Практические советы

- Начинайте с `--dry-run` и небольшого `--limit`, чтобы оценить качество перевода.
- Если OpenRouter отвечает ошибкой, уменьшите `--concurrency` или повторите позже.
- Для больших прогонов делите процесс по сущностям (сначала `universities`, затем `reviews` и т.д.).
- Перед массовыми изменениями создайте бэкап БД или коммит, чтобы можно было откатиться.

## Частые проблемы

| Симптом | Решение |
| --- | --- |
| `OPENROUTER_API_KEY not set` | Экспортируйте ключ или добавьте его в `.env` |
| Ошибка подключения к БД | Проверьте `DATABASE_URL`, запущенные контейнеры и миграции |
| `PrismaClientInitializationError` | Выполните `npx prisma generate` и убедитесь, что схема актуальна |
| Некорректный JSON после перевода | Повторите с `--limit` и вручную исправьте проблемные записи |

