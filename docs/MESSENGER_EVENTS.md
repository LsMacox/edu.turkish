# API: логирование событий в мессенджерах

`POST /api/v1/messenger-events` фиксирует обращения пользователей в Bitrix в виде активности. Эндпоинт
используется фронтендом (виджет/кнопка мессенджера) и позволяет связать переходы по реферальным ссылкам с UTM
и дополнительной аналитикой.

## Структура запроса

| Поле | Тип | Обязательное | Ограничение | Описание |
| --- | --- | --- | --- | --- |
| `channel` | string | да | до 120 символов | Человекочитаемый идентификатор канала (`telegram`, `whatsapp:+90000000000`, `instagram` и т.п.).
| `referral_code` | string | да | до 120 символов | Код источника/реферальной точки на сайте (например, `landing_header_cta`).
| `session` | string | нет | до 200 символов | Произвольный идентификатор клиентской сессии или визита.
| `utm` | object | нет | см. ниже | Набор стандартных UTM-меток кампании.
| `metadata` | object | нет | см. ниже | Дополнительные атрибуты, описывающие место клика.

Поля очищаются (обрезка пробелов) и отклоняются, если пустые или превышают ограничение. Лишние поля в объекте
запроса игнорируются.

### Поля `utm`

Каждый ключ — необязательная строка до 200 символов. Пустые строки отбрасываются.

| Поле | Назначение |
| --- | --- |
| `utm_source` | Канал привлечения (например, `google`, `telegram`). |
| `utm_medium` | Тип трафика (`cpc`, `social`, `referral`). |
| `utm_campaign` | Название кампании. |
| `utm_content` | Дополнительное уточнение креатива/кнопки. |
| `utm_term` | Ключевое слово или иная метка для поиска. |

### Поля `metadata`

Каждый ключ — необязательная строка до 200 символов (для `notes` — до 500). Пробелы удаляются, пустые значения
отбрасываются. Пример использования — фиксация, с какой страницы или блока был совершен клик.

| Поле | Назначение |
| --- | --- |
| `page` | URL или псевдоним страницы, где произошёл переход. |
| `section` | Название секции/экрана внутри страницы. |
| `component` | Компонент интерфейса (`floating_button`, `footer_link`). |
| `campaign` | Внутренний идентификатор кампании/оффера. |
| `referrer` | Источник, с которого пользователь попал на страницу. |
| `notes` | Свободный текст для дополнительных пометок (до 500 символов). |

### Пример запроса

```http
POST /api/v1/messenger-events
Content-Type: application/json

{
  "channel": "telegram",
  "referral_code": "landing_header_cta",
  "session": "3b8fc0af-1c6c-42ff-bf4c-8e2f48971dd4",
  "utm": {
    "utm_source": "telegram",
    "utm_medium": "organic",
    "utm_campaign": "spring_launch",
    "utm_content": "floating_button"
  },
  "metadata": {
    "page": "/",
    "section": "hero",
    "component": "floating_button",
    "notes": "first visit"
  }
}
```

## Ответ

```json
{
  "success": true,
  "activityId": 9685
}
```

- `success` — флаг успешной записи в Bitrix.
- `activityId` — идентификатор созданной активности (или `null`, если Bitrix не вернул значение).

## Возможные ошибки

| Код | Сообщение | Когда возникает |
| --- | --- | --- |
| `400` | `Channel is required` / `Referral code is required` | В запросе отсутствует одно из обязательных полей или оно пустое после очистки. |
| `400` | `Invalid messenger event payload` | Bitrix отклонил payload после дополнительной валидации (например, слишком длинные значения). |
| `503` | `Bitrix integration is not configured` | В переменных окружения не задана конфигурация Bitrix (см. [настройку](./BITRIX_SETUP.md)). |
| `502` | `Failed to log messenger event` | Bitrix API вернул ошибку или недоступно — повторный запрос возможен позже. |

## Взаимодействие с Bitrix

Эндпоинт использует те же настройки интеграции, что и отправка заявок. Активность создаётся через метод
`crm.activity.add` и будет содержать канал, реферальный код, а также JSON-представление UTM и metadata в описании.
Убедитесь, что переменные окружения для Bitrix заданы, иначе API вернёт `503`.

